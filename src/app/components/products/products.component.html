<div class="page">
  <div class="container-inner">
    <div class="hero-card">
      <div class="hero-left">
        <div class="hero-icon">
          <span class="material-icons">show_chart</span>
        </div>
        <div>
          <h2>Autoflex</h2>
          <p>Gerenciamento completo de produtos e matérias-primas</p>
        </div>
      </div>
    </div>

    <div class="tabs-card">
      <div class="tabs">
        <button
          class="tab"
          [class.active]="activeTab === 'products'"
          (click)="setActiveTab('products')"
          type="button"
        >
          <span class="material-icons">inventory_2</span>
          <span>Produtos</span>
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'rawMaterials'"
          (click)="setActiveTab('rawMaterials')"
          type="button"
        >
          <span class="material-icons">category</span>
          <span>Matérias-Primas</span>
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'production'"
          (click)="setActiveTab('production')"
          type="button"
          [disabled]="!isProductionTabEnabled"
          [title]="!isProductionTabEnabled ? 'Aguarde o carregamento dos dados' : ''"
        >
          <span class="material-icons">analytics</span>
          <span>Análise de Produção</span>
          <span *ngIf="!isProductionTabEnabled" class="loading-dot"></span>
        </button>
      </div>
    </div>

    <div class="content-card" *ngIf="activeTab === 'products'">
      <div class="controls">
        <div class="search">
          <span class="material-icons search-icon">search</span>
          <input type="text" placeholder="Buscar produtos..." [(ngModel)]="searchTerm" />
        </div>
        <button class="new-btn" (click)="openNewProductModal()" type="button">
          <span class="material-icons">add</span>
          <span>Novo Produto</span>
        </button>
      </div>

      <div class="product-list">
        <div class="product-card" *ngFor="let p of filteredProducts">
          <div class="card-left">
            <strong>{{ p.name }}</strong>
            <p class="code-text">Código: {{ p.code }}</p>
            <div class="meta">
              <span class="price">
                Preço: <span class="price-green">{{ formatCurrency(p.price || 0) }}</span>
              </span>
              <span class="raw-materials"> Matérias-primas: {{ p.rawMaterials.length }} </span>
            </div>
          </div>
          <div class="card-right">
            <button class="icon" title="Editar" (click)="openEditProductModal(p)" type="button">
              <span class="material-icons">edit</span>
            </button>
            <button class="icon delete" title="Excluir" (click)="deleteProduct(p)" type="button">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>

        <div class="empty-state" *ngIf="filteredProducts.length === 0 && !isLoading">
          <span class="material-icons">inbox</span>
          <p>Nenhum produto encontrado</p>
        </div>
      </div>
    </div>

    <div class="content-card" *ngIf="activeTab === 'rawMaterials'">
      <div class="controls">
        <div class="search">
          <span class="material-icons search-icon">search</span>
          <input type="text" placeholder="Buscar matérias-primas..." [(ngModel)]="searchTerm" />
        </div>
        <button class="new-btn" (click)="openNewRawMaterialModal()" type="button">
          <span class="material-icons">add</span>
          <span>Nova Matéria-Prima</span>
        </button>
      </div>

      <div class="product-list">
        <div class="product-card" *ngFor="let rm of filteredRawMaterials">
          <div class="card-left">
            <strong>{{ rm.name }}</strong>
            <p class="code-text">Código: {{ rm.code }}</p>
            <div class="meta">
              <span class="stock" [class.low-stock]="(rm.stock || 0) < 10">
                Estoque: <strong>{{ formatForDisplay(rm.stock) }} unidades</strong>
              </span>
            </div>
          </div>
          <div class="card-right">
            <button
              class="icon"
              title="Editar"
              (click)="openEditRawMaterialModal(rm)"
              type="button"
            >
              <span class="material-icons">edit</span>
            </button>
            <button
              class="icon delete"
              title="Excluir"
              (click)="deleteRawMaterial(rm)"
              type="button"
            >
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>

        <div class="empty-state" *ngIf="filteredRawMaterials.length === 0 && !isLoading">
          <span class="material-icons">inbox</span>
          <p>Nenhuma matéria-prima encontrada</p>
        </div>
      </div>
    </div>

    <div class="content-card" *ngIf="activeTab === 'production'">
      <div class="production-header">
        <h3>Análise de Produção Otimizada</h3>
        <p>Produtos priorizados por maior valor, considerando estoque disponível</p>
      </div>

      <div class="production-summary" *ngIf="productionSuggestions.length > 0">
        <div class="summary-card">
          <span class="material-icons">inventory</span>
          <div>
            <strong>{{ productionSuggestions.length }}</strong>
            <span>Produtos Possíveis</span>
          </div>
        </div>
        <div class="summary-card highlight">
          <span class="material-icons">attach_money</span>
          <div>
            <strong>{{ formatCurrency(getTotalProductionValue()) }}</strong>
            <span>Valor Total</span>
          </div>
        </div>
      </div>

      <div class="production-list">
        <div
          class="production-card"
          *ngFor="let suggestion of productionSuggestions; let i = index"
        >
          <div class="production-header-card">
            <div class="production-number">{{ i + 1 }}</div>
            <div class="production-info">
              <strong>{{ suggestion.product.name }}</strong>
              <p>Código: {{ suggestion.product.code }}</p>
            </div>
          </div>

          <div class="production-stats">
            <div class="stat">
              <span class="label">Quantidade Máxima</span>
              <span class="value">{{ formatForDisplay(suggestion.maxQuantity) }} unidades</span>
            </div>
            <div class="stat">
              <span class="label">Valor Unitário</span>
              <span class="value">{{ formatCurrency(suggestion.product.price || 0) }}</span>
            </div>
            <div class="stat highlight">
              <span class="label">Valor Total</span>
              <span class="value">{{ formatCurrency(suggestion.totalValue) }}</span>
            </div>
          </div>

          <div class="materials-used">
            <h4>Matérias-primas utilizadas:</h4>
            <div class="materials-grid">
              <div class="material-item" *ngFor="let used of suggestion.rawMaterialsUsed">
                <span class="material-name">{{ used.rawMaterial.name }}</span>
                <span class="material-qty">{{ formatForDisplay(used.quantityUsed) }} unidades</span>
              </div>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="productionSuggestions.length === 0">
          <span class="material-icons">warning</span>
          <p>Não há estoque suficiente para produzir nenhum produto</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showProductModal" (click)="closeProductModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingProduct ? 'Editar Produto' : 'Novo Produto' }}</h3>
      <button class="close-btn" (click)="closeProductModal()" type="button">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <div class="form-group" *ngIf="!editingProduct">
        <label>Código</label>
        <input type="text" [(ngModel)]="productForm.code" placeholder="Ex: PROD001" readonly />
      </div>

      <div class="form-group" *ngIf="editingProduct">
        <label>Código</label>
        <input type="text" [(ngModel)]="productForm.code" readonly class="disabled-input" />
      </div>

      <div class="form-group">
        <label>Nome do Produto</label>
        <input type="text" [(ngModel)]="productForm.name" placeholder="Ex: Mesa de Madeira" />
      </div>

      <div class="form-group">
        <label>Preço (R$)</label>
        <input
          type="number"
          [ngModel]="productForm.price"
          (ngModelChange)="productForm.price = $event"
          step="0.01"
          min="0"
          placeholder="0,00"
        />
      </div>

      <div class="form-section">
        <div class="section-header">
          <label>Matérias-Primas</label>
          <button class="add-btn" (click)="addRawMaterialToProduct()" type="button">
            <span class="material-icons">add</span>
            Adicionar
          </button>
        </div>

        <div class="materials-list" *ngIf="productForm.rawMaterials.length > 0">
          <div class="material-row" *ngFor="let rm of productForm.rawMaterials; let i = index">
            <select [(ngModel)]="rm.rawMaterialId" class="material-select">
              <option value="">Selecione a matéria-prima</option>
              <option *ngFor="let raw of rawMaterials" [value]="raw.id">
                {{ raw.name }}
              </option>
            </select>
            <input
              type="number"
              [(ngModel)]="rm.quantity"
              step="0.01"
              placeholder="Qtd"
              class="quantity-input"
              min="0.01"
            />
            <button class="remove-btn" (click)="removeRawMaterialFromProduct(i)" type="button">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>

        <div class="empty-materials" *ngIf="productForm.rawMaterials.length === 0">
          <p>Nenhuma matéria-prima adicionada</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" (click)="closeProductModal()" type="button">Cancelar</button>
      <button
        class="save-btn"
        (click)="saveProduct()"
        type="button"
        [disabled]="!editingProduct && !isProductFormValid()"
      >
        Salvar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showRawMaterialModal" (click)="closeRawMaterialModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingRawMaterial ? 'Editar Matéria-Prima' : 'Nova Matéria-Prima' }}</h3>
      <button class="close-btn" (click)="closeRawMaterialModal()" type="button">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <div class="form-group" *ngIf="!editingRawMaterial">
        <label>Código</label>
        <input type="text" [(ngModel)]="rawMaterialForm.code" placeholder="Ex: MP001" readonly />
      </div>

      <div class="form-group" *ngIf="editingRawMaterial">
        <label>Código</label>
        <input type="text" [(ngModel)]="rawMaterialForm.code" readonly class="disabled-input" />
      </div>

      <div class="form-group">
        <label>Nome da Matéria-Prima</label>
        <input type="text" [(ngModel)]="rawMaterialForm.name" placeholder="Ex: Tábua de Madeira" />
      </div>

      <div class="form-group">
        <label>Estoque Atual (unidades)</label>
        <input
          type="number"
          [ngModel]="rawMaterialForm.stock"
          (ngModelChange)="rawMaterialForm.stock = $event"
          step="0.01"
          placeholder="0"
          min="0"
        />
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" (click)="closeRawMaterialModal()" type="button">Cancelar</button>
      <button
        class="save-btn"
        (click)="saveRawMaterial()"
        type="button"
        [disabled]="!editingRawMaterial && !isRawMaterialFormValid()"
      >
        Salvar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal confirm-modal" (click)="$event.stopPropagation()">
    <div class="modal-body confirm-body">
      <div class="confirm-icon">
        <span class="material-icons">warning</span>
      </div>
      <h3>{{ confirmTitle }}</h3>
      <p>{{ confirmMessage }}</p>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" (click)="closeConfirmModal()" type="button">Cancelar</button>
      <button class="save-btn" (click)="confirmDelete()" type="button" style="background: #ef4444">
        Excluir
      </button>
    </div>
  </div>
</div>
